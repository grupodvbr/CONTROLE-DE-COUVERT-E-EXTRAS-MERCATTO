<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>CONTROLE DE COUVERT E EXTRAS - MERCATTO DELÍCIA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
    }
    #loading-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #loading-screen img {
      width: 200px;
      animation: fadeIn 1s ease-in-out;
    }
    #loading-message {
      font-size: 18px;
      margin-top: 20px;
      color: #333;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    header img {
      height: 50px;
      margin-right: 20px;
    }
    h1 { font-size: 1.5em; }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[readonly] {
      background: #eee;
    }
    button {
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #34495e;
    }
    table {
      width: calc(100% - 40px);
      margin: 0 20px 20px;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 13px;
    }
    .pago { background: #c8f7c5; }
    .pendente { background: #f7c5c5; }
    .lancado { background: #fdf4c5; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    #filtros {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px 10px;
      gap: 10px;
    }

    #filtros select, #filtros button {
      padding: 8px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      #filtros {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <div id="loading-screen">
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <p id="loading-message">Carregando...</p>
  </div>

  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <h1>CONTROLE DE COUVERT E EXTRA - MERCATTO DELÍCIA</h1>
  </header>

  <form id="form">
    <div><label>CPF ou CNPJ</label><input type="text" name="cpf" id="cpfCnpj" required placeholder="Digite o número verdadeiro"></div>
    <div><label>Mês</label><select name="mes" id="mes" required></select></div>
    <div><label>Data</label><input type="date" name="data" required></div>
    <div><label>Profissional</label><input list="listaProfissionais" name="profissional" id="profissional" required><datalist id="listaProfissionais"></datalist></div>
    <div><label>Função</label><input type="text" name="funcao" id="funcao" required></div>
    <div><label>Dados bancários / Pix</label><input type="text" name="dadosPix" id="dadosPix" required></div>
    <div><label>Titular da Conta</label><input type="text" name="titularConta" id="titularConta" required></div>
    <div><label>Tempo</label><input type="text" name="tempo" required></div>
    <div><label>Valor acordado (R$)</label><input type="number" name="valorAcordado" id="valorAcordado" step="0.01" required></div>
    <div><label>Bonificação (R$)</label><input type="number" name="bonificacao" id="bonificacao" step="0.01" required></div>
    <div><label>Desconto de consumo (R$)</label><input type="number" name="desconto" id="desconto" step="0.01" required></div>
    <div><label>Valor final (R$)</label><input type="number" name="valorFinal" id="valorFinal" step="0.01" readonly></div>
    <div><label>Data Pagamento</label><input type="date" name="dataPagamento" required></div>
    <div>
      <label>Status</label>
      <select name="status" required>
        <option value="PENDENTE">PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <div style="grid-column: span 3;"><button type="submit">Salvar</button></div>
  </form>

  <div id="filtros">
    <div>
      <label>Filtrar por status:</label>
      <select id="filtroStatus">
        <option value="TODOS">TODOS</option>
        <option value="PENDENTE" selected>PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <button onclick="liquidarEmMassa()">Liquidar em Massa</button>
  </div>

  <table id="tabela">
    <thead>
     <tr>
  <th>Data</th><th>Profissional</th><th>Função</th><th>Pix</th><th>Titular</th><th>Tempo</th>
  <th>Valor Acordado</th><th>Bonificação</th><th>Desconto</th><th>Valor Final</th>
  <th>Data Pagamento</th><th><strong>CPF</strong></th>
  <th>Status</th><th>Ações</th>
</tr>

    </thead>
    <tbody></tbody>
  </table>

  <script>
    const URL = 'https://script.google.com/macros/s/AKfycbxLxl-FL5_6J06gBULz0QcaCGMovJ1opY9_5UG6vNDv0L_-KyCvAOPkN_F9Cy0cZHJW0Q/exec';
    const form = document.getElementById('form');
    const filtroStatus = document.getElementById('filtroStatus');
    let profissionais = [], dadosLancamentos = [];

  function proximaSegunda(dataRef = new Date()) {
    const dia = dataRef.getDay(); // 0 = domingo, 1 = segunda, ..., 6 = sábado
    const diasParaSegunda = dia === 1 ? 7 : (8 - dia); // sempre próxima segunda, mesmo se hoje for segunda
    const proxima = new Date(dataRef);
    proxima.setDate(proxima.getDate() + diasParaSegunda);
    return proxima.toISOString().split('T')[0];
  }
 
document.addEventListener('DOMContentLoaded', () => {
  const hoje = new Date();
  const nomesMeses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
  const selectMes = document.getElementById('mes');

  for (let i = 0; i < 12; i++) {
    const option = document.createElement('option');
    option.value = `${nomesMeses[i]} de ${hoje.getFullYear()}`;
    option.textContent = `${nomesMeses[i]} de ${hoje.getFullYear()}`;
    if (i === hoje.getMonth()) option.selected = true;
    selectMes.appendChild(option);
  }

  document.querySelector('input[name="data"]').value = hoje.toISOString().split('T')[0];
  document.querySelector('input[name="dataPagamento"]').value = proximaSegunda(hoje);

    });

    fetch(`${URL}?acao=profissionais`).then(res => res.json()).then(data => {
      profissionais = data;
      const lista = document.getElementById('listaProfissionais');
      lista.innerHTML = '';
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nome;
        lista.appendChild(opt);
      });
    });

    document.getElementById('profissional').addEventListener('input', () => {
      const nomeDigitado = profissional.value.trim().toUpperCase();
      const p = profissionais.find(p => p.nome.trim().toUpperCase() === nomeDigitado);

      if (p) {
        funcao.value = p.funcao || '';
        dadosPix.value = p.pix || '';
        titularConta.value = p.titular || '';
        valorAcordado.value = p.valor || '';
        cpfCnpj.value = p.cpf || '';

        funcao.readOnly = true;
        dadosPix.readOnly = true;
        titularConta.readOnly = true;
        valorAcordado.readOnly = false;
        cpfCnpj.readOnly = true;
        funcao.style.background = '#eee';
        dadosPix.style.background = '#eee';
        titularConta.style.background = '#eee';
        cpfCnpj.style.background = '#eee';
        valorAcordado.style.background = '';
      } else {
        funcao.value = '';
        dadosPix.value = '';
        titularConta.value = '';
        valorAcordado.value = '';
        cpfCnpj.value = '';

        funcao.readOnly = false;
        dadosPix.readOnly = false;
        titularConta.readOnly = false;
        valorAcordado.readOnly = false;
        cpfCnpj.readOnly = false;
        funcao.style.background = '';
        dadosPix.style.background = '';
        titularConta.style.background = '';
        cpfCnpj.style.background = '';
        valorAcordado.style.background = '';
      }
    });

    [valorAcordado, desconto].forEach(input => {
      input.addEventListener('input', () => {
        const v = parseFloat(valorAcordado.value) || 0;
        const d = parseFloat(desconto.value) || 0;
        valorFinal.value = (v - d).toFixed(2);
      });
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const btn = form.querySelector('button[type="submit"]');
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');

      btn.disabled = true;
      btn.textContent = 'Salvando...';
      msg.textContent = 'Salvando dados...';
      loading.style.display = 'flex';

      const dados = Object.fromEntries(new FormData(form));
      dados.acao = 'adicionar';

      fetch(URL, {
        method: 'POST',
        body: JSON.stringify(dados)
      }).then(() => {
        form.reset();
        filtroStatus.value = 'PENDENTE';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'Salvar';
          loading.style.display = 'none';
          carregarLancamentos();
        }, 1500);
      });
    });

    filtroStatus.addEventListener('change', carregarLancamentos);

    function carregarLancamentos() {
      fetch(`${URL}?acao=ler`).then(res => res.json()).then(data => {
        dadosLancamentos = data;
        const tbody = document.querySelector('#tabela tbody');
        tbody.innerHTML = '';
        const filtro = filtroStatus.value || 'PENDENTE';
        data.forEach(item => {
          if (filtro !== 'TODOS' && item.status !== filtro) return;
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', item.index);
          tr.className = item.status.toLowerCase();
          tr.innerHTML = `
            <td>${item.data?.split('T')[0] || ''}</td>
            <td>${item.profissional}</td>
            <td>${item.funcao || ''}</td>
            <td>${item.pix || ''}</td>
            <td>${item.titular || ''}</td>
            <td>${item.tempo || ''}</td>
            <td>R$ ${(item.valorAcordado || 0).toFixed(2)}</td>
            <td>R$ ${(item.bonificacao || 0).toFixed(2)}</td>
            <td>R$ ${(item.desconto || 0).toFixed(2)}</td>
            <td>R$ ${(item.valorFinal || 0).toFixed(2)}</td>
            <td>${item.dataPagamento ? new Date(item.dataPagamento).toLocaleDateString('pt-BR') : ''}</td>
            <td>${item.cpf || ''}</td>

            <td>
              <select onchange="atualizarStatus(this, ${item.index})">
                <option value="PENDENTE" ${item.status === 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
                <option value="LANÇADO" ${item.status === 'LANÇADO' ? 'selected' : ''}>LANÇADO</option>
                <option value="PAGO" ${item.status === 'PAGO' ? 'selected' : ''}>PAGO</option>
              </select>
            </td>
            <td><div class="actions"><button onclick="excluir(${item.index})">Excluir</button></div></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function atualizarStatus(select, index) {
      const status = select.value;
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');

      msg.textContent = 'Atualizando status...';
      loading.style.display = 'flex';

      fetch(URL, {
        method: 'POST',
        body: JSON.stringify({ acao: 'atualizarStatus', index, status })
      })
      .then(() => {
        setTimeout(() => location.reload(), 1500);
      });
    }

    function excluir(index) {
      const senha = prompt("Digite a senha para excluir:");
      if (senha === '1234') {
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'excluir', index })
        }).then(() => {
          const linha = document.querySelector(`tr[data-index="${index}"]`);
          if (linha) linha.remove();
        });
      } else {
        alert("Senha incorreta.");
      }
    }

    function liquidarEmMassa() {
      const filtro = filtroStatus.value;
      if (filtro === 'TODOS' || filtro === 'PAGO') {
        alert("Selecione um status válido (PENDENTE ou LANÇADO) para liquidar.");
        return;
      }
      if (!confirm(`Deseja marcar todos os registros com status "${filtro}" como PAGO?`)) return;

      const promessas = dadosLancamentos.filter(item => item.status === filtro).map(item =>
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'atualizarStatus', index: item.index, status: 'PAGO' })
        })
      );
      Promise.all(promessas).then(() => {
        alert("Todos os registros foram atualizados para PAGO.");
        location.reload();
      });
    }

    window.addEventListener('load', () => {
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');
      msg.textContent = 'Carregando...';
      setTimeout(() => {
        loading.style.display = 'none';
        filtroStatus.value = 'PENDENTE';
        carregarLancamentos();
      }, 2000);
    });
  </script>

  <script>
    const cpfCnpjInput = document.getElementById("cpfCnpj");

    cpfCnpjInput.addEventListener("input", () => {
      let v = cpfCnpjInput.value.replace(/\D/g, "");

      if (v.length <= 11) {
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d)/, "$1.$2");
        v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
      } else {
        v = v.replace(/^(\d{2})(\d)/, "$1.$2");
        v = v.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
        v = v.replace(/\.(\d{3})(\d)/, ".$1/$2");
        v = v.replace(/(\d{4})(\d)/, "$1-$2");
      }

      cpfCnpjInput.value = v;
    });

    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
      let soma = 0;
      for (let i = 0; i < 9; i++) soma += +cpf[i] * (10 - i);
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== +cpf[9]) return false;
      soma = 0;
      for (let i = 0; i < 10; i++) soma += +cpf[i] * (11 - i);
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      return resto === +cpf[10];
    }

    function validarCNPJ(cnpj) {
      cnpj = cnpj.replace(/\D/g, '');
      if (cnpj.length !== 14 || /^(\d)\1+$/.test(cnpj)) return false;
      let t = cnpj.length - 2, d = cnpj.substring(t), d1 = +d[0], d2 = +d[1];
      let calc = x => {
        let n = cnpj.substring(0, x);
        let r = 0, pos = x - 7;
        for (let i = x; i >= 1; i--) {
          r += +n[x - i] * pos--;
          if (pos < 2) pos = 9;
        }
        return ((r % 11) < 2 ? 0 : 11 - (r % 11));
      };
      return calc(t) === d1 && calc(t + 1) === d2;
    }

    document.getElementById('form').addEventListener('submit', function (e) {
      const doc = cpfCnpjInput.value.replace(/\D/g, '');
      if (doc.length <= 11) {
        if (!validarCPF(doc)) {
          alert('CPF inválido!');
          e.preventDefault();
          cpfCnpjInput.focus();
        }
      } else {
        if (!validarCNPJ(doc)) {
          alert('CNPJ inválido!');
          e.preventDefault();
          cpfCnpjInput.focus();
        }
      }
    });
  </script>

</body>
</html>
